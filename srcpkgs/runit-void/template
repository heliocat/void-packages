# Template file for 'runit-void'
pkgname=runit-void
version=20210314
revision=2
wrksrc="void-runit-${version}"
build_style=gnu-makefile
short_desc="Void Linux runit scripts"
maintainer="Enno Boland <gottox@voidlinux.org>"
license="CC0-1.0"
homepage="https://github.com/void-linux/void-runit"
distfiles="https://github.com/void-linux/void-runit/archive/${version}.tar.gz"
checksum=9ac95a14b5e1aedfcf0b093b8992b08316448ac1afb7fd26501ac43c4ebf3847

depends="virtual?awk procps-ng runit"
conf_files="
 /etc/hostname
 /etc/locale.conf
 /etc/rc.conf
 /etc/rc.local
 /etc/rc.shutdown
 /etc/sv/agetty-console/conf
 /etc/sv/agetty-serial/conf
 /etc/sv/agetty-tty1/conf
 /etc/sv/agetty-hvc0/conf
 /etc/sv/agetty-hvsi0/conf"

alternatives="
 void-init:init:/usr/bin/runit-init
 void-init:halt:/usr/bin/halt-runit
 void-init:poweroff:/usr/bin/poweroff-runit
 void-init:reboot:/usr/bin/reboot-runit
 void-init:shutdown:/usr/bin/shutdown-runit"

make_dirs="
 /etc/zzz.d/suspend 0755 root root
 /etc/zzz.d/resume 0755 root root"

post_install() {
	vmkdir usr/bin
	mv ${DESTDIR}/usr/sbin/* ${DESTDIR}/usr/bin
	mv ${DESTDIR}/usr/bin/halt ${DESTDIR}/usr/bin/halt-runit
	mv ${DESTDIR}/usr/bin/shutdown ${DESTDIR}/usr/bin/shutdown-runit
	ln -sf halt-runit ${DESTDIR}/usr/bin/poweroff-runit
	ln -sf halt-runit ${DESTDIR}/usr/bin/reboot-runit
	vconf ${FILESDIR}/hostname
	vconf ${FILESDIR}/os-release
	vconf ${FILESDIR}/locale.conf
	vinstall ${FILESDIR}/apparmor 644 /etc/default/
	vinstall ${FILESDIR}/09-apparmor.sh 644 /etc/runit/core-services/
	# Enable services at post-install time instead.
	rm -f ${DESTDIR}/etc/runit/runsvdir/current
	rm -rf ${DESTDIR}/etc/runit/runsvdir/default
	rm -rf ${DESTDIR}/etc/runit/runsvdir/single
	# Remove extraneous power symlinks
	rm ${DESTDIR}/usr/bin/poweroff
	rm ${DESTDIR}/usr/bin/reboot
}

runit-void-apparmor_package() {
	short_desc+=" - AppArmor initialization"
	depends="${sourcepkg}-${version}_${revision}"
	conf_files="/etc/default/apparmor"
	pkg_install() {
		vmove etc/default/apparmor
		vmove etc/runit/core-services/09-apparmor.sh
	}
}
